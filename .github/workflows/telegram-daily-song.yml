name: Send Daily Song to Telegram

on:
  schedule:
    # Runs at 7:30 AM PST (15:30 UTC) daily
    # Note: Adjust to 14:30 UTC during PDT (spring/summer)
    - cron: '30 15 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  send-song:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install js-yaml
        run: npm install js-yaml
      
      - name: Send today's song to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          cat > send-song.js << 'SCRIPT'
          const https = require('https');
          const fs = require('fs');
          const yaml = require('js-yaml');
          
          const botToken = process.env.TELEGRAM_BOT_TOKEN;
          
          // Load subscribers
          let subscribers = { users: [] };
          if (fs.existsSync('_data/telegram_subscribers.json')) {
            subscribers = JSON.parse(fs.readFileSync('_data/telegram_subscribers.json', 'utf8'));
          }
          
          if (subscribers.users.length === 0) {
            console.log('No subscribers yet');
            process.exit(0);
          }
          
          console.log(`Sending to ${subscribers.users.length} subscriber(s)`);
          
          // Read and parse YAML file
          const dailySongs = yaml.load(fs.readFileSync('_data/daily_song.yml', 'utf8'));
          
          // Get today's date in MM-DD format
          const today = new Date();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const todayDate = `${month}-${day}`;
          
          // Format date as YYYY-MM-DD (Day)
          const year = today.getFullYear();
          const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
          const formattedDate = `${year}-${month}-${day} (${dayName})`;
          
          console.log(`Looking for song with date: ${todayDate}`);
          
          // Find today's song
          const todaySong = dailySongs.find(song => song.date === todayDate);
          
          if (!todaySong) {
            console.error(`No song found for ${todayDate}`);
            process.exit(1);
          }
          
          console.log(`Found song: ${todaySong.track}`);
          
          // Build YouTube Music URL
          const youtubeUrl = `https://music.youtube.com/watch?v=${todaySong.songId}`;
          
          // Create message
          const message = `${formattedDate}:\n\nðŸŽµ <b>"${todaySong.track}"</b>\n\nðŸŽ§ <a href="${youtubeUrl}">Listen on YouTube Music</a>`;
          
          // Send to all subscribers
          const sendPromises = subscribers.users.map(user => {
            return new Promise((resolve, reject) => {
              const postData = JSON.stringify({
                chat_id: user.chat_id,
                text: message,
                parse_mode: 'HTML',
                disable_web_page_preview: false
              });
              
              const options = {
                hostname: 'api.telegram.org',
                path: `/bot${botToken}/sendMessage`,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': postData.length
                }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  const response = JSON.parse(data);
                  if (response.ok) {
                    console.log(`âœ“ Sent to ${user.username || user.chat_id}`);
                    resolve();
                  } else {
                    console.error(`âœ— Failed to send to ${user.username || user.chat_id}:`, response);
                    resolve(); // Don't fail entire job if one send fails
                  }
                });
              });
              
              req.on('error', (error) => {
                console.error(`âœ— Error sending to ${user.username || user.chat_id}:`, error.message);
                resolve(); // Don't fail entire job
              });
              
              req.write(postData);
              req.end();
            });
          });
          
          await Promise.all(sendPromises);
          console.log('All messages sent!');
          EOF
